<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
       
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <title>Plans</title>
</head>

<body>
    <header >
        <!-- Logo (No Blur) -->
        <div class="logo text-dark">Mobi-Comm</div>
        <div class="navbar-container">
            <nav class="navbar navbar-expand-lg glass-navbar" id="dynamicNavbar">
                <div class="container-fluid justify-content-center">
                    <div class="navbar-nav">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                        <a class="nav-link active" href="viewplans.html">
                            <i class="fas fa-list"></i> View Plans
                        </a>
                        <a class="nav-link" href="contact.html">
                            <i class="fas fa-envelope"></i> Contact
                        </a>
                    </div>
                </div>
            </nav>
          
        </div>
        
 
        
      
        <!-- My Account Icon (No Blur) -->
        <div class="account-icon">
            <a class="nav-link dropdown btn-dark" href="#" id="accountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle text-dark"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" id="dropdownMenu">
                <li><a class="dropdown-item" href="login-page.html" id="loginLink">Login</a></li>
            </ul>
        </div>
        
              </header>
              
              <div class="container-fluid mt-2 d-flex justify-content-end">
                <button class="btn filter-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterCanvas" aria-controls="filterCanvas">
                    <i class="fas fa-sliders-h"></i> Filter
                </button>
            </div>
            
            
            <div class="offcanvas offcanvas-end " tabindex="-1" id="filterCanvas" aria-labelledby="filterCanvasLabel" style="visibility: visible;">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="filterCanvasLabel">Filter Plans</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <p class="fw-bold">Select Plan Category</p>
                    <ul class="list-group" id="filterOptions">
                        <li class="list-group-item"><input type="checkbox" value="popular_plans"> Popular Plans</li>
                        <li class="list-group-item"><input type="checkbox" value="true_5g_unlimited"> True 5G Unlimited</li>
                        <li class="list-group-item"><input type="checkbox" value="entertainment_plans"> Entertainment Plans</li>
                        <li class="list-group-item"><input type="checkbox" value="annual_plans"> Annual Plans</li>
                        <li class="list-group-item"><input type="checkbox" value="phone_plans"> Phone Plans</li>
                        <li class="list-group-item"><input type="checkbox" value="isd_plans"> ISD Plans</li>
                        <li class="list-group-item"><input type="checkbox" value="data_packs"> Data Packs</li>
                    </ul>
                    
                    <p class="fw-bold mt-3">Filter by Price</p>
                    <input type="range" id="priceRange" class="form-range" min="0" max="5000" step="100" oninput="updatePriceValue(this.value)">
                    <p id="priceValue" class="text-center">â‚¹0 - â‚¹5000</p>
                    
                    <p class="fw-bold mt-3">Filter by Data</p>
                    <input type="number" id="minData" class="form-control mb-2" placeholder="Min Data (GB)">
                    <input type="number" id="maxData" class="form-control mb-2" placeholder="Max Data (GB)">
                    
                    <p class="fw-bold mt-3">Filter by Validity</p>
                    <input type="number" id="minValidity" class="form-control mb-2" placeholder="Min Validity (Days)">
                    <input type="number" id="maxValidity" class="form-control mb-2" placeholder="Max Validity (Days)">
                    
                    <button class="btn btn-primary mt-3 w-100" onclick="applyFilters()">Apply Filter</button>
                </div>
            </div>
            

              <section >
                
                <div class="container-fluid pb-5">
                     <div class="row">
                         <!-- Sidebar (Left Navigation) -->
                         <div class="col-md-3 col-lg-2 sidebar p-3">
                            <p class="fw-bolder pt-2 pb-2 sidebar-heading" style="font-size: x-large;color: yellow;">Plan Category</p>
                            <div class="nav-container">
                                <ul class="nav nav-pills flex-nowrap" id="planTabs"></ul>
                            </div>
                        </div>
             
                         <div class="col-md-9 col-lg-10 p-4" data-aos="slide-down" data-aos-delay="200">
                            <div class="tab-content" id="planContent">
                                <div id="popular_plans"></div>
                                <div id="true_5g_unlimited"></div>
                                <div id="entertainment_plans"></div>
                                <div id="annual_plans"></div>
                                <div id="phone_plans"></div>
                                <div id="isd_plans"></div>
                                <div id="data_packs"></div>
                                
                            </div>
                        </div>
                        
        </div>
    </div>
    </div>

</section>
</div>
<section class="banner">
    <footer>
        <div>
            <img class="responsive-image" src="assets/imges/wave2.png" alt="">
        </div>   
        <div class="container-fluid px-5" data-aos="fade-up" data-aos-delay="100">
            <div class="row">
                <div class="col-lg-4" data-aos="fade-left" data-aos-delay="100">
                    <p class="display-6 text-white p-3" data-aos="fade-left" data-aos-delay="100" >Mobi-Comm</p>
                    <p class="lead text-white">"Stay connected, stay aheadâ€”MobiComm makes mobile recharging faster, easier, and more rewarding."</p>
                </div>
                <div class="col-lg-4">
                    <p class="display-6 text-white p-3" data-aos="fade-left" data-aos-delay="100" >Quick Links</p>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white text-decoration-none" data-aos="fade-left" data-aos-delay="100">Home</a></li>
                        <li><a href="viewplans.html" class="text-white text-decoration-none" data-aos="fade-left" data-aos-delay="100">View Plans</a></li>
                        <li><a href="contact.html" class="text-white text-decoration-none" data-aos="fade-left" data-aos-delay="100">Contact Us</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3" data-aos="fade-left" data-aos-delay="100">
                    <p class="display-6 text-white p-3">Follow Us</p>
                    <div class="d-flex gap-3" data-aos="fade-left" data-aos-delay="100">
                        <a href="#" class="text-white fs-4" data-aos="fade-left" data-aos-delay="100"><i class="bi bi-facebook"></i></a>
                        <a href="#" class="text-white fs-4" data-aos="fade-left" data-aos-delay="100"><i class="bi bi-twitter"></i></a>
                        <a href="#" class="text-white fs-4" data-aos="fade-left" data-aos-delay="100"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</section>  
<!--GetPlan Modal -->
<div class="modal fade" id="getplanModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 text-center rounded-4 shadow-lg glass-effect">
            <!-- Close Button -->
            <button type="button" class="btn-close position-absolute end-0 top-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>

            <!-- Rupee Icon -->
            <div class="icon-circle bg-light mx-auto">
                <span class="rupee-icon">â‚¹</span>
            </div>

            <!-- Modal Title -->
            <h3 class="fw-bold mt-3">Recharge</h3>
            <p class="text-muted mb-4">Enter your MobiComm Number</p>

            <!-- Mobile Number Input with Icon -->
            <div class="input-container">
                <i class="fas fa-mobile-alt input-icon"></i>
                <input type="text" id="phone2" class="form-control input-glow" placeholder="Mobile Number" maxlength="10">
            </div>

            <!-- Error Message -->
            <p id="error-message" class="text-danger mt-2" style="display: none; font-size: 14px;"></p>

            <!-- Continue Button -->
            <button type="button" class="btn gradient-btn w-100 py-2 mt-4" id="continue">
                Continue
            </button>
        </div>
    </div>
</div>



<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

     <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script src="json.js"></script>

   
<script>
    document.addEventListener("DOMContentLoaded", function() {
        let filterButton = document.querySelector('[data-bs-target="#filterCanvas"]');
        if (filterButton) {
            filterButton.classList.remove("d-lg-none");
            filterButton.classList.add("d-block");
        }
    });
    
    function updatePriceValue(value) {
        document.getElementById("priceValue").innerText = `â‚¹0 - â‚¹${value}`;
    }
    
    function applyFilters() {
        let selectedFilters = [];
        document.querySelectorAll('#filterOptions input:checked').forEach(checkbox => {
            selectedFilters.push(checkbox.value);
        });
        
        let maxPrice = document.getElementById('priceRange').value || Infinity;
        let minData = document.getElementById('minData').value || 0;
        let maxData = document.getElementById('maxData').value || Infinity;
        let minValidity = document.getElementById('minValidity').value || 0;
        let maxValidity = document.getElementById('maxValidity').value || Infinity;
        
        document.querySelectorAll('.tab-content > div').forEach(section => {
            let plans = section.querySelectorAll('.plan-card');
            plans.forEach(plan => {
                let price = parseFloat(plan.getAttribute('data-price')) || 0;
                let data = parseFloat(plan.getAttribute('data-data')) || 0;
                let validity = parseFloat(plan.getAttribute('data-validity')) || 0;
                
                let matchesPrice = price <= maxPrice;
                let matchesData = data >= minData && data <= maxData;
                let matchesValidity = validity >= minValidity && validity <= maxValidity;
                let matchesCategory = selectedFilters.length === 0 || selectedFilters.includes(section.id);
                
                if (matchesPrice && matchesData && matchesValidity && matchesCategory) {
                    plan.style.display = 'block';
                } else {
                    plan.style.display = 'none';
                }
            });
        });
    }
    document.addEventListener("DOMContentLoaded", function () {
    console.log("âœ… Page Loaded, Initializing Payment Setup...");
    setupPaymentButton();
});

// âœ… Open Recharge Modal & Store Plan Data
function openRechargeModal(button) {
    const planData = JSON.parse(button.getAttribute("data-plan"));
    sessionStorage.setItem("selectedPlan", JSON.stringify(planData));

    let modalElement = document.getElementById("getplanModal");
    if (!modalElement) {
        console.error("âŒ Modal element not found!");
        return;
    }

    let modal = new bootstrap.Modal(modalElement);
    modal.show();
}

// âœ… Validate Mobile Number
async function validateMobileNumberModal() {
    let mobileInput = document.getElementById("phone2");
    let errorText = document.getElementById("error-message");
    let continueButton = document.getElementById("continue");

    if (!mobileInput || !errorText || !continueButton) {
        console.error("âŒ Required elements not found!");
        return;
    }

    let mobileNumber = mobileInput.value.trim();
    if (!/^[6-9]\d{9}$/.test(mobileNumber)) {
        errorText.innerText = "Please enter a valid 10-digit mobile number.";
        errorText.style.display = "block";
        continueButton.disabled = true;
        return;
    }

    try {
        console.log("ðŸ”„ Checking user for mobile number:", mobileNumber);
        const response = await fetch(`http://localhost:8081/api/users/phone/${mobileNumber}`);

        if (!response.ok) throw new Error(`Mobile number not found. Status: ${response.status}`);

        const user = await response.json();
        console.log("âœ… User data fetched:", user);

        if (!user.userEmail) {
            console.warn("âš ï¸ No email found for this user.");
        }

        // Ensure empty values are stored properly
        sessionStorage.setItem("mobileNumber", mobileNumber);
        sessionStorage.setItem("userDetails", JSON.stringify({
            userId: user.userId,
            userName: user.userName,
            userEmail: user.userEmail || "", // Default to empty string if missing
            phoneNumber: user.phoneNumber,
            dateOfBirth: user.dateOfBirth,
            status: user.status,
            addresses: user.addresses
        }));

        console.log("ðŸ“Œ Stored in sessionStorage:", {
            mobileNumber: sessionStorage.getItem("mobileNumber"),
            userDetails: sessionStorage.getItem("userDetails")
        });

        errorText.style.display = "none";
        continueButton.disabled = false;
    } catch (error) {
        console.error("âŒ Error fetching user data:", error.message);
        errorText.innerText = "Mobile number not found. Please enter a valid number.";
        errorText.style.display = "block";
        continueButton.disabled = true;
    }
}

// âœ… Setup Payment Button
function setupPaymentButton() {
    const payButton = document.getElementById("continue");
    if (!payButton) {
        console.error("âŒ Pay Button not found on the page!");
        return;
    }

    payButton.addEventListener("click", async function () {
        console.log("ðŸ›’ Pay Button Clicked! Initiating Payment...");

        try {
            const orderData = await createOrder();
            if (!orderData || !orderData.id) {
                console.error("âš ï¸ Invalid Order Response:", orderData);
                alert("Failed to get payment session. Check console.");
                return;
            }

            console.log("âœ… Order Created Successfully. Razorpay Order ID:", orderData.id);
            startRazorpayPayment(orderData);
        } catch (error) {
            console.error("âŒ Payment Process Failed:", error);
            alert("Payment process failed. Check console.");
        }
    });
}
// âœ… Create Order API Request (Backend)
async function createOrder() {
    console.log("ðŸ”„ Creating Order with Backend...");

    const mobileNumber = sessionStorage.getItem("mobileNumber");
    const selectedPlan = JSON.parse(sessionStorage.getItem("selectedPlan"));

    if (!mobileNumber || !selectedPlan) {
        console.error("âŒ Missing order details.");
        alert("Error: Missing mobile number or plan details.");
        return null;
    }

    try {
        const response = await fetch(`http://localhost:8081/api/payment/create-order?amount=${selectedPlan.price}`, {
            method: "POST"
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`âŒ Request Failed: ${response.status} - ${errorText}`);
        }

        return await response.json();
    } catch (error) {
        console.error("âŒ Order Creation Failed:", error.message);
        alert("Payment failed. Please try again.");
        return null;
    }
}

// âœ… Start Razorpay Payment
function startRazorpayPayment(orderData) {
    const options = {
        key: "rzp_test_7jbN2F87afR6Hf",
        amount: orderData.amount,
        currency: "INR",
        name: "MobiComm",
        description: "Recharge Payment",
        order_id: orderData.id,
        handler: function (response) {
            console.log("âœ… Payment Successful:", response);
            handlePaymentSuccess(orderData.id, response.razorpay_payment_id);
        },
        prefill: {
            contact: sessionStorage.getItem("mobileNumber")
        },
        theme: {
            color: "#512DA8"
        }
    };

    const rzp = new Razorpay(options);
    rzp.open();
}
// âœ… Handle Payment Success
async function handlePaymentSuccess(orderId, paymentId) {
    console.log("ðŸ“¡ Storing Recharge Details in Backend...");

    const mobileNumber = sessionStorage.getItem("mobileNumber");
    const selectedPlan = JSON.parse(sessionStorage.getItem("selectedPlan"));
    const userDetails = JSON.parse(sessionStorage.getItem("userDetails"));

    console.log("ðŸ“© User Details from Session:", userDetails); // Debugging
    console.log("ðŸ“¦ Selected Plan from Session:", selectedPlan);

    if (!mobileNumber || !selectedPlan || !orderId) {
        console.error("âŒ Missing order details. Cannot store recharge history.");
        alert("Error: Missing required details for recharge.");
        return;
    }

    // Ensure plan name is correctly extracted
    const planName = selectedPlan.planName || selectedPlan.name || "Unknown Plan";

    const requestBody = {
        transactionId: paymentId,
        planId: selectedPlan.planId,
        mobileNumber: mobileNumber,
        amount: selectedPlan.price,
        paymentMethod: "Razorpay",
        status: "PAID"
    };

    try {
        const response = await fetch("http://localhost:8081/api/payment/verify-payment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        });

        const responseData = await response.json();
        if (!response.ok) {
            throw new Error(`âŒ API Error: ${response.status} - ${responseData?.message || "Unknown error"}`);
        }

        console.log("âœ… Recharge Data Stored Successfully:", responseData);
        alert(responseData?.message || "Recharge Successful! Plan Activated.");

        // Ensure email exists before sending confirmation
        if (userDetails && userDetails.userEmail) {
            sendEmailConfirmation(userDetails.userEmail, paymentId, mobileNumber, planName, selectedPlan.price, "Razorpay");
        } else {
            console.warn("âš ï¸ No email found, skipping email confirmation.");
        }
    } catch (error) {
        console.error("âŒ Failed to Store Recharge Details:", error);
        alert("Recharge was not stored. Check console for details.");
    }
}

async function sendEmailConfirmation(userEmail, transactionId, mobileNumber, planName, amount, paymentMethod) {
    console.log("ðŸ“© Final Email Data:", {
    userEmail, transactionId, mobileNumber, planName, amount, paymentMethod
});
    console.log("\ud83d\udce9 Sending email to:", userEmail);

    if (!userEmail) {
        console.error("\u274c Error: Email is null or undefined");
        alert("Email address is missing!");
        return;
    }

    const emailBody = `
        <div style="font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4;">
            <div style="max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0,0,0,0.1);">
                <h2 style="color: #512DA8; text-align: center;">\u2728 Payment Successful! \u2728</h2>
                <hr style="border: 1px solid #ddd;">
                <p style="font-size: 16px; color: #424242;">Dear Customer,</p>
                <p style="font-size: 16px; color: #424242;">We are thrilled to inform you that your recharge was <strong>successfully completed</strong>! Here are the details of your transaction:</p>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">\ud83c\udfe0 Mobile Number:</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${mobileNumber}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">\ud83d\udcb3 Payment Method:</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${paymentMethod}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">\ud83d\udcda Plan:</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${planName}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">\ud83d\udcb8 Amount Paid:</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">\u20b9${amount}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">\ud83c\udfc6 Transaction ID:</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${transactionId}</td>
                    </tr>
                </table>

                <p style="font-size: 16px; color: #424242; margin-top: 20px;">Thank you for choosing <strong>MobiComm</strong>. If you have any questions, feel free to contact our support team.</p>

                <div style="text-align: center; margin-top: 20px;">
                    <a href="http://127.0.0.1:5503/index.html" style="padding: 10px 20px; background-color: #512DA8; color: white; text-decoration: none; border-radius: 5px; font-size: 16px;">Visit Our Website</a>
                </div>

                <p style="font-size: 14px; color: #777; text-align: center; margin-top: 20px;">\u00a9 ${new Date().getFullYear()} MobiComm. All rights reserved.</p>
            </div>
        </div>
    `;

    try {
        const response = await fetch("http://localhost:8081/email/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                to: userEmail,
                subject: "\u2728 MobiComm - Payment Successful! \u2728",
                body: emailBody
            })
        });

        if (response.ok) {
            alert("Email confirmation sent successfully!");
        } else {
            alert("Failed to send email confirmation.");
        }
    } catch (error) {
        console.error("\u274c Error sending email:", error);
        alert("Error sending email.");
    }
}



// Attach event listener for the modal input
document.getElementById("phone2").addEventListener("input", function () {
    validateMobileNumberModal();
});


    </script>
    
        

    
    
</body>
</html>