<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>Plans</title>
</head>
<body>
    <header>
        <div class="logo text-dark">Mobi-Comm</div>
        <div class="navbar-container">
            <nav class="navbar navbar-expand-lg glass-navbar" id="dynamicNavbar">
                <div class="container-fluid justify-content-center">
                    <div class="navbar-nav">
                        <a class="nav-link" href="index.html"><i class="fas fa-home"></i> Home</a>
                        <a class="nav-link active" href="viewplans.html"><i class="fas fa-list"></i> View Plans</a>
                        <a class="nav-link" href="contact.html"><i class="fas fa-envelope"></i> Contact</a>
                    </div>
                </div>
            </nav>
        </div>
        <div class="account-icon">
            <a class="nav-link dropdown btn-dark" href="#" id="accountDropdown" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle text-dark"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" id="dropdownMenu">
                <li><a class="dropdown-item" href="login-page.html">Login</a></li>
            </ul>
        </div>
    </header>

    <section style="margin-top: 80px;">
        <div class="container-fluid pb-5">
            <div class="row">
                <div class="col-md-3 col-lg-2 sidebar p-3 mt-3">
                    <p class="fw-bolder pt-2 pb-2 sidebar-heading" style="font-size: x-large;color: yellow;">Plan Category</p>
                    <div class="nav-container">
                        <ul class="nav nav-pills flex-nowrap" id="planTabs"></ul>
                    </div>
                </div>
                <div class="col-md-9 col-lg-10 p-4">
                    <div class="tab-content" id="planContent"></div>
                </div>
            </div>
        </div>

  <!-- Modal Structure -->
  <div class="modal fade" id="getplanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content custom-modal">
        <div class="modal-header border-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div class="icon-container">
            <img src="https://cdn-icons-png.flaticon.com/512/833/833313.png" alt="Recharge Icon" width="50">
          </div>
          <h3 class="modal-title fw-bold mt-2">Recharge</h3>
          <p class="text-muted">Enter your Jio number</p>
  
          <div class="form-group mt-3">
            <label class="form-label">Mobile number</label>
            <input type="text" class="form-control" id="mobile-number" placeholder="Enter your number">
          </div>
  
          <button class="btn continue-btn w-100 mt-4" id="payBtn">Continue</button>
        </div>
      </div>
    </div>
  </div>
  
    </section>

    <script src="json.js"></script>
 <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
 <script>
    document.addEventListener("DOMContentLoaded", async function () {
        console.log("‚úÖ Page Loaded, Initializing Payment Setup...");

        try {
            await waitForCashfreeSDK();
            console.log("‚úÖ Cashfree SDK Loaded Successfully");
        } catch (error) {
            console.error("‚ùå Cashfree SDK Failed to Load:", error);
            alert("Failed to load Cashfree SDK. Check console for details.");
            return;
        }

        setupPaymentButton();
    });

    function waitForCashfreeSDK() {
        return new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
                clearInterval(check);
                reject(new Error("Cashfree SDK not loaded after 10 seconds"));
            }, 10000);

            const check = setInterval(() => {
                if (window.Cashfree) {
                    clearTimeout(timeout);
                    clearInterval(check);
                    resolve();
                }
            }, 500);
        });
    }

    async function validateMobileNumberModal() {
        let mobileInput = document.getElementById("mobile-number");
        let errorText = document.getElementById("modal-error-text");
        let mobileNumber = mobileInput.value.trim();

        // ‚úÖ Validate mobile number format
        if (!/^[6-9]\d{9}$/.test(mobileNumber)) {
            errorText.innerText = "Please enter a valid 10-digit mobile number.";
            document.getElementById("payBtn").disabled = true;
            return;
        }

        try {
            console.log("üîÑ Checking user for mobile number:", mobileNumber);
            const response = await fetch(`http://localhost:8081/api/users/phone/${mobileNumber}`);

            if (!response.ok) {
                throw new Error("Mobile number not found");
            }

            const user = await response.json();
            console.log("‚úÖ User data fetched:", user);

            // ‚úÖ Store user details for payment processing
            sessionStorage.setItem("mobileNumber", mobileNumber);
            sessionStorage.setItem("userDetails", JSON.stringify(user));

            errorText.innerText = "";
            document.getElementById("payBtn").disabled = false; // Enable payment button

        } catch (error) {
            console.error("‚ùå Error fetching user data:", error);
            errorText.innerText = "Mobile number not found. Please enter a valid number.";
            document.getElementById("payBtn").disabled = true;
        }
    }

    function setupPaymentButton() {
        const payButton = document.getElementById("payBtn");

        if (!payButton) {
            console.error("‚ùå Pay Button not found on the page!");
            alert("Payment button is missing. Cannot proceed.");
            return;
        }

        payButton.addEventListener("click", async function () {
            console.log("üõí Pay Button Clicked! Initiating Payment...");

            try {
                const orderData = await createOrder();

                if (!orderData || !orderData.paymentSessionId) {
                    console.error("‚ö†Ô∏è Invalid Order Response:", orderData);
                    alert("Failed to get payment session. Check console.");
                    return;
                }

                console.log("‚úÖ Order Created Successfully. Session ID:", orderData.paymentSessionId);

                const cashfree = Cashfree({ mode: "sandbox" });

                const checkoutResponse = cashfree.checkout({
                    paymentSessionId: orderData.paymentSessionId,
                    redirect: false
                });

                console.log("üîç Checkout Initiated, Waiting for User Interaction...");

                checkoutResponse.then((paymentResponse) => {
                    console.log("‚úÖ Payment Completed:", paymentResponse);

                    if (paymentResponse.order && paymentResponse.order.status) {
                        const orderStatus = paymentResponse.order.status;
                        const paymentMethod = paymentResponse.transaction.paymentMethod;
                        console.log("üìå Order Status from Cashfree:", orderStatus);
                        if (orderStatus === "PAID") {
                            handlePaymentSuccess(orderStatus, paymentMethod);
                        } else {
                            console.error("‚ö†Ô∏è Order not successful.");
                        }
                    } else {
                        console.error("‚ö†Ô∏è Order status not found in response.");
                    }
                }).catch(error => {
                    console.error("‚ùå Payment Modal Error:", error);
                    alert("Payment failed. Check console for details.");
                });

            } catch (error) {
                console.error("‚ùå Payment Process Failed:", error);
                alert("Payment process failed. Check console.");
            }
        });
    }

    async function createOrder() {
        console.log("üîÑ Creating Order with Backend...");

        const mobileNumber = sessionStorage.getItem("mobileNumber");
        const selectedPlan = JSON.parse(sessionStorage.getItem("selectedPlan"));
        const userDetails = JSON.parse(sessionStorage.getItem("userDetails"));

        console.log("üìå mobileNumber:", mobileNumber);
        console.log("üìå selectedPlan:", selectedPlan);
        console.log("üìå userDetails:", userDetails);

        if (!mobileNumber || !selectedPlan || !userDetails) {
            console.error("‚ùå Missing order details. Cannot create order.");
            alert("Error: Missing mobile number or plan details.");
            return null;
        }

        const orderPayload = {
            orderId: "order_" + Date.now(),
            amount: selectedPlan.price,
            currency: "INR",
            customerPhone: mobileNumber,
            customerDetails: {
                userId: userDetails.userId,
                userName: userDetails.userName,
                userEmail: userDetails.userEmail,
                phone: mobileNumber
            },
            planId: selectedPlan.planId
        };

        try {
            const response = await fetch("http://localhost:8081/api/orders/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderPayload)
            });

            const data = await response.json();
            console.log("‚úÖ Backend Response:", data);

            if (!response.ok || !data.paymentSessionId) {
                throw new Error(`Server returned ${response.status}: ${JSON.stringify(data)}`);
            }

            sessionStorage.setItem("orderId", orderPayload.orderId);
            return data;

        } catch (error) {
            console.error("‚ùå Order Creation Failed:", error);
            throw error;
        }
    }

    async function handlePaymentSuccess(orderStatus, paymentMethod) {
        const mobileNumber = sessionStorage.getItem("mobileNumber");
        const selectedPlan = JSON.parse(sessionStorage.getItem("selectedPlan"));
        const orderId = sessionStorage.getItem("orderId");

        if (!mobileNumber || !selectedPlan || !orderId) {
            console.error("‚ùå Missing order details. Cannot process payment.");
            return;
        }

        await sendPaymentWebhook(
            orderStatus,
            selectedPlan.planId,
            mobileNumber,
            selectedPlan.price,
            paymentMethod
        );
    }

    async function sendPaymentWebhook(orderStatus, planId, mobileNumber, price, paymentMethod) {
        const paymentData = {
            orderStatus: orderStatus, 
            planId: planId,
            customerPhone: mobileNumber,
            orderAmount: price,
            paymentMethod: paymentMethod
        };

        console.log("üìå Sending webhook payload to backend:", paymentData);
        try {
            const response = await fetch("http://localhost:8081/api/payment/webhook", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(paymentData)
            });

            const data = await response.json();
            console.log("‚úÖ Webhook Response:", data);

            if (!response.ok) {
                throw new Error(`Webhook Error: ${response.status}`);
            }

            alert("üéâ Payment successful! Your plan is activated.");
            window.location.reload();

        } catch (error) {
            console.error("‚ùå Webhook Failed:", error);
            alert("Error processing payment. Check console.");
        }
    }
</script>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
